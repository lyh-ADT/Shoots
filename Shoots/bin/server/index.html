<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Client</title>
    <style>
        *{
            margin: 0;
        }
    </style>
</head>
<body>
    <script>
        class Display{
            constructor(){
                this.width = 0;
                this.size_per_block = 50;
                this.canvas = null;
                this.map = [];
                this.initCanvas();
            }

            initCanvas(){
                this.width = Math.min(window.innerWidth, window.innerHeight);
                this.canvas = document.createElement("canvas");
                this.canvas.width = this.canvas.height = this.width;
                document.body.appendChild(this.canvas);
                let ctx = this.canvas.getContext("2d");
                ctx.fillStyle = "black";
                ctx.fillRect(0, 0, this.width, this.width);
            }

            drawMap(){
                this.size_per_block = Math.round(this.width / (this.map.length+2));

                this.drawBlock(0, 0, this.width, "black");

                for(let x in this.map){
                    for(let y in this.map[x]){
                        let color = "black";
                        if(this.map[x][y]){
                            color = "white";
                        }
                        this.drawBlock(parseInt(x)+1, parseInt(y)+1, this.size_per_block, color);

                    }
                }
            }

            drawBlock(x, y, size, color, offset=0, rotate=0){
                let ctx = this.canvas.getContext("2d");
                const x_for_canvas = y*this.size_per_block+offset;
                const y_for_canvas = x*this.size_per_block+offset;

                ctx.translate(x_for_canvas + size/2, y_for_canvas + size/2);
                ctx.rotate(rotate);
                ctx.translate(-(x_for_canvas + size/2), -(y_for_canvas + size/2));

                ctx.fillStyle = color;
                ctx.fillRect(x_for_canvas, y_for_canvas, size, size);
            }

            drawDot(x, y, size, color, offset=0){
                let ctx = this.canvas.getContext("2d");
                ctx.fillStyle = color;
                ctx.arc(y*this.size_per_block + size + offset, x*this.size_per_block + size + offset, size, 0, 2 * Math.PI);
                ctx.fill();
            }

            drawShooter(x, y, isSelf=false){
                x += 1;
                y += 1;
                const shooter_offset = 20;
                const shooter_size = this.size_per_block-shooter_offset;
                this.drawBlock(x, y, shooter_size, "red", shooter_offset / 2, Math.PI / 4);
                if(isSelf){
                    this.drawDot(x, y, shooter_size / 2, "yellow", shooter_offset / 2);
                }
            }

            processData(data){
                this.map = data.map;
                this.drawMap();
                this.drawShooter(data.position[0], data.position[1], true);
            }
        }

    </script>
    <script>
        let display = new Display();
        // display.map = [
        //     [1,1,1,1,1],
        //     [0,0,0,0,1],
        //     [1,1,1,1,1],
        //     [1,0,1,0,1],
        //     [1,1,1,0,1]
        // ];
        // display.drawMap();

    </script>
    <script>
    
        let ws = new WebSocket("ws://"+location.host+"/websocket");
        ws.onopen = function(){
            console.info("websocket opened");
        }
        ws.onmessage = function(evt){
            console.log(evt.data);
            let data = JSON.parse(evt.data);
            display.processData(data);
        }
    </script>
</body>
</html>